package com.example.project

import android.graphics.Color
import android.os.Bundle
import android.util.Log
import android.view.ViewGroup
import android.widget.FrameLayout
import android.widget.ImageButton
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.example.project.databinding.ActivityDongDetailBinding
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.GoogleMap
import com.google.android.gms.maps.OnMapReadyCallback
import com.google.android.gms.maps.SupportMapFragment
import com.google.android.gms.maps.model.*
import com.google.android.material.bottomsheet.BottomSheetBehavior

class DongDetailActivity : AppCompatActivity(), OnMapReadyCallback {

    private lateinit var mMap: GoogleMap
    private lateinit var bottomSheetBehavior: BottomSheetBehavior<LinearLayout>
    private lateinit var dongName: String
    private lateinit var mapContainer: FrameLayout

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val binding = ActivityDongDetailBinding.inflate(layoutInflater)
        setContentView(binding.root)

        setSupportActionBar(binding.toolbar)
        supportActionBar?.setDisplayHomeAsUpEnabled(true)
        binding.toolbar.setNavigationOnClickListener {
            onBackPressedDispatcher.onBackPressed()
        }

        dongName = intent.getStringExtra("dongName") ?: "Ï†ïÏôï1Îèô"
        val parkList = getParkList(dongName)

        val bottomSheet = findViewById<LinearLayout>(R.id.bottomSheet)
        mapContainer = findViewById(R.id.mapContainer)

        bottomSheetBehavior = BottomSheetBehavior.from(bottomSheet).apply {
            peekHeight = 0
            isHideable = true
            state = BottomSheetBehavior.STATE_HIDDEN
        }

        findViewById<TextView>(R.id.toolbarTitle).text = dongName
        findViewById<TextView>(R.id.dongdetailname).text = dongName
        findViewById<TextView>(R.id.toolbarSubtitle).text = "Í≥µÏõê ¬∑ ${parkList.size}Í∞ú Í≤∞Í≥º"

        val mapFragment = supportFragmentManager.findFragmentById(R.id.map) as SupportMapFragment
        mapFragment.getMapAsync(this)

        findViewById<ImageButton>(R.id.closeBottomSheetButton).setOnClickListener {
            bottomSheetBehavior.state = BottomSheetBehavior.STATE_HIDDEN
            val layoutParams = mapContainer.layoutParams
            layoutParams.height = ViewGroup.LayoutParams.MATCH_PARENT
            mapContainer.layoutParams = layoutParams
        }
    }

    private fun getParkList(dong: String): List<ListItem> {
        return parksByDong[dong]?.map { park ->
            ListItem(park.name, park.imageResId)
        } ?: emptyList()
    }

    private fun drawPolylinesFromTxt(dong: String) {
        val fileResId = when (dong) {
            "Í±∞Î∂ÅÏÑ¨Îèô" -> R.raw.geobukseom_polyline
            "Íµ∞ÏûêÎèô" -> R.raw.gunjadong_polyline
            "Îä•Í≥°Îèô" -> R.raw.neunggokdong_polyline
            "ÎåÄÏïºÎèô" -> R.raw.daeya_polyline
            "Î™©Í∞êÎèô" -> R.raw.mokgamdong_polyline
            "Î∞∞Í≥ß1Îèô" -> R.raw.baegot1_polyline
            "Î∞∞Í≥ß2Îèô" -> R.raw.baegot2_polyline
            "Ïã†Ï≤úÎèô" -> R.raw.sincheon_polyline
            "Ïó∞ÏÑ±Îèô" -> R.raw.yeonsung_polyline
            "ÏùÄÌñâÎèô" -> R.raw.eunhaung_polyline
            "Ïû•Í≥°Îèô" -> R.raw.janggok_polyline
            "Ï†ïÏôï1Îèô" -> R.raw.jeongwang1dong_polyline
            "Ï†ïÏôï2Îèô" -> R.raw.jeongwang2_polyline
            "Ï†ïÏôï3Îèô" -> R.raw.jeongwang3_polyline
            "Ï†ïÏôï4Îèô" -> R.raw.jeongwang4_polyline
            "Ï†ïÏôïÎ≥∏Îèô" -> R.raw.jeongwangbon_polyline
            else -> return
        }
        try {
            val inputStream = resources.openRawResource(fileResId)
            val lines = inputStream.bufferedReader().readLines()

            var currentLine = mutableListOf<LatLng>()
            for (line in lines) {
                if (line.trim() == "---") {
                    if (currentLine.isNotEmpty()) {
                        mMap.addPolyline(
                            PolylineOptions()
                                .addAll(currentLine)
                                .color(Color.RED)
                                .width(8f)
                        )
                        currentLine.clear()
                    }
                } else {
                    val latLngString = line.removePrefix("LatLng(").removeSuffix(")")
                    val parts = latLngString.split(",")
                    if (parts.size == 2) {
                        val lat = parts[0].trim().toDouble()
                        val lng = parts[1].trim().toDouble()
                        currentLine.add(LatLng(lat, lng))
                    }
                }
            }

            if (currentLine.isNotEmpty()) {
                mMap.addPolyline(
                    PolylineOptions()
                        .addAll(currentLine)
                        .color(Color.RED)
                        .width(8f)
                )
            }

        } catch (e: Exception) {
            Log.e("TXT", "Í≤ΩÍ≥ÑÏÑ† Ìè¥Î¶¨ÎùºÏù∏ Í∑∏Î¶¨Í∏∞ Ïã§Ìå®", e)
        }
    }

    override fun onMapReady(googleMap: GoogleMap) {
        mMap = googleMap

        mMap.setMapStyle(MapStyleOptions.loadRawResourceStyle(this, R.raw.map_style))
        mMap.uiSettings.isZoomControlsEnabled = true
        mMap.setMinZoomPreference(14.7f)

        val centerLatLng = when (dongName) {
            "Í±∞Î∂ÅÏÑ¨Îèô" -> LatLng(37.324748, 126.684966)
            "Íµ∞ÏûêÎèô" -> LatLng(37.356642, 126.778763)
            "Îä•Í≥°Îèô" -> LatLng(37.365299, 126.809174)
            "ÎåÄÏïºÎèô" -> LatLng(37.453077, 126.799569)
            "Î™©Í∞êÎèô" -> LatLng(37.382090, 126.851719)
            "Î∞∞Í≥ß1Îèô" -> LatLng(37.376067, 126.730287)
            "Î∞∞Í≥ß2Îèô" -> LatLng(37.362662, 126.717535)
            "Ïã†Ï≤úÎèô" -> LatLng(37.438679, 126.780113)
            "Ïó∞ÏÑ±Îèô" -> LatLng(37.388891, 126.805796)
            "ÏùÄÌñâÎèô" -> LatLng(37.432588, 126.807991)
            "Ïû•Í≥°Îèô" -> LatLng(37.382528, 126.783634)
            "Ï†ïÏôï1Îèô" -> LatLng(37.331675, 126.735278)
            "Ï†ïÏôï2Îèô" -> LatLng(37.341702, 126.721225)
            "Ï†ïÏôï3Îèô" -> LatLng(37.343833, 126.706295)
            "Ï†ïÏôï4Îèô" -> LatLng(37.362508, 126.731116)
            "Ï†ïÏôïÎ≥∏Îèô" -> LatLng(37.358199, 126.751292)
            else -> LatLng(37.33, 126.73)
        }
        mMap.moveCamera(CameraUpdateFactory.newLatLngZoom(centerLatLng, 14.7f))

        val restrictionBounds = when (dongName) {
            "Í±∞Î∂ÅÏÑ¨Îèô" -> LatLngBounds(LatLng(37.318, 126.66), LatLng(37.33, 126.71))
            "Íµ∞ÏûêÎèô"   -> LatLngBounds(LatLng(37.348, 126.765), LatLng(37.362, 126.794))
            "Îä•Í≥°Îèô"   -> LatLngBounds(LatLng(37.364, 126.802), LatLng(37.368, 126.815))
            "ÎåÄÏïºÎèô"   -> LatLngBounds(LatLng(37.44, 126.79), LatLng(37.47, 126.81))
            "Î™©Í∞êÎèô"   -> LatLngBounds(LatLng(37.37, 126.84), LatLng(37.39, 126.87))
            "Î∞∞Í≥ß1Îèô" -> LatLngBounds(LatLng(37.36, 126.72), LatLng(37.39, 126.74))
            "Î∞∞Í≥ß2Îèô" -> LatLngBounds(LatLng(37.35, 126.71), LatLng(37.38, 126.73))
            "Ïã†Ï≤úÎèô"   -> LatLngBounds(LatLng(37.43, 126.77), LatLng(37.45, 126.80))
            "Ïó∞ÏÑ±Îèô"   -> LatLngBounds(LatLng(37.38, 126.80), LatLng(37.40, 126.82))
            "ÏùÄÌñâÎèô"   -> LatLngBounds(LatLng(37.42, 126.80), LatLng(37.44, 126.82))
            "Ïû•Í≥°Îèô"   -> LatLngBounds(LatLng(37.38, 126.78), LatLng(37.40, 126.79))
            "Ï†ïÏôï1Îèô" -> LatLngBounds(LatLng(37.33, 126.73), LatLng(37.35, 126.75))
            "Ï†ïÏôï2Îèô" -> LatLngBounds(LatLng(37.34, 126.71), LatLng(37.36, 126.73))
            "Ï†ïÏôï3Îèô" -> LatLngBounds(LatLng(37.34, 126.70), LatLng(37.36, 126.72))
            "Ï†ïÏôï4Îèô" -> LatLngBounds(LatLng(37.36, 126.73), LatLng(37.38, 126.75))
            "Ï†ïÏôïÎ≥∏Îèô" -> LatLngBounds(LatLng(37.35, 126.74), LatLng(37.37, 126.76))
            else       -> LatLngBounds(LatLng(37.32, 126.68), LatLng(37.48, 126.88))
        }
        mMap.setLatLngBoundsForCameraTarget(restrictionBounds)

        drawPolylinesFromTxt(dongName)

        val parkMarkers = parksByDong[dongName] ?: emptyList()
        for (park in parkMarkers) {
            val marker = mMap.addMarker(
                MarkerOptions().position(park.latLng).title(park.name)
            )
            marker?.tag = park.name
            Log.d("MAP", "ÏùºÎ∞ò ÎßàÏª§ Ï∂îÍ∞ÄÎê®: ${park.name}")
        }

        val parkImage = findViewById<ImageView>(R.id.parkImage)
        val parkInfo = findViewById<TextView>(R.id.parkInfo)

        mMap.setOnMarkerClickListener { marker ->
            Log.d("MAP", "‚úÖ ÎßàÏª§ ÌÅ¥Î¶≠Îê®: ${marker.title}, tag=${marker.tag}")
            val park = (parksByDong[dongName] ?: emptyList()).find { it.name == marker.tag }

            if (park != null) {
                parkImage.setImageResource(park.imageResId)

                val infoText = buildString {
                    append("üìç Ïù¥Î¶Ñ: ${park.name}\n")
                    append("üó∫Ô∏è Ï£ºÏÜå: ${park.address ?: "Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå"}\n")
                    append("‚ÑπÔ∏è ÏÑ§Î™Ö: ${park.description ?: "ÏÑ§Î™Ö ÏóÜÏùå"}")
                }
                parkInfo.text = infoText

                findViewById<TextView>(R.id.dongdetailname).text = park.name

                val screenHeight = resources.displayMetrics.heightPixels
                val offset = screenHeight / 6
                val projection = mMap.projection
                val markerPoint = projection.toScreenLocation(marker.position)
                markerPoint.y += offset.toInt()

                val newLatLng = projection.fromScreenLocation(markerPoint)
                mMap.animateCamera(CameraUpdateFactory.newLatLng(newLatLng))
                marker.showInfoWindow()

                val halfHeight = resources.displayMetrics.heightPixels / 2
                bottomSheetBehavior.peekHeight = halfHeight
                bottomSheetBehavior.state = BottomSheetBehavior.STATE_COLLAPSED

                Log.d("MAP", "‚úÖ Î∞îÌÖÄÏãúÌä∏ Ïó¥Î¶º: ${park.name}")
            } else {
                Log.d("MAP", "‚ùå Ìï¥Îãπ ÎßàÏª§Ïóê ÎåÄÌïú Í≥µÏõê Ï†ïÎ≥¥ ÏóÜÏùå")
            }
            true
        }

        mMap.setOnInfoWindowClickListener {
            Log.d("MAP", "‚ÑπÔ∏è InfoWindow ÌÅ¥Î¶≠Îê®: ${it.title}")
        }
    }
}
